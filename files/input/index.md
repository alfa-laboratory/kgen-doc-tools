# Описание схем взаимодействия

## 1. Одностадийная оплата с указанием карточных данных на платёжной странице

### 1.1. Сценарий оплаты заказа

![Сценарий 1](/images/s1.png)

Одностадийная схема оплаты картой:

1. Клиент оформляет заказ на ресурсе мерчанта и выбирает способ оплаты банковской картой.  

2. После того как выбран способ оплаты банковской картой, в сторону платежного шлюза должен быть отправлен запрос регистрации заказа. Для регистрации используются такие параметры как сумма списания, номер заказа в системе магазина, а также URL возврата клиента. Спецификация запроса представлена в разделах:
    - "Запрос регистрации заказа" (SOAP),
    - "Запрос регистрации заказа" (REST).

3. В ответе на запрос регистрации платежный шлюз возвращает уникальный идентификатор заказа в платежной системе (в параметре orderId) и URL, на который необходимо перенаправить пользователя для получения платежной формы (в параметре formUrl).

4. Система магазина должна передать браузеру клиента redirect на URL, полученный от платежного шлюза в параметре formUrl в ответ на запрос регистрации заказа.

5. Браузер клиента открывает полученный URL.

6. Клиент получает платёжную форму.

7. Пользователь заполняет полученную форму реквизитами карты и отправляет данные на сервер платежного шлюза.

8. Детали заказа передаются в систему фрод-конроля для определения вероятности мошенничества. Проверка проводится при помощи набора автоматических правил. Результатом применения правила является добавление к заказу коэффициента вероятности мошенничества (фрод-веса). Каждое правило имеет свой фрод-вес, который представляет собой число в диапазоне от 0 до 100. (Если суммарный фрод-вес заказа по всем применённым к заказу правилам превышает 100, такой заказ считается фродовым и оплата по нему будет отклонена.)

9. В платёжный шлюз возвращаются результаты проверки заказа на мошенничество.В том случае, если в соответствии с настройками магазина платёж должен идти по SSL, то выполняется следующий шаг сценария (10).  
Если в соответствии с настройками магазина платёж должен быть 3DS, то будут выполнены следующие действия:  
	- Платёжный шлюз производит проверку вовлечённости карты в 3-D Secure. Если авторизации на ACS для данной карты не требуется, то выполняется следующий шаг сценария (10). Если необходима авторизация на ACS, то будут выполнены следующие действия:  
  1. Шлюз отправляет браузеру клиента redirect на страницу ACS банка эмитента.
  2. Браузер клиента запрашивает у ACS форму авторизации пользователя (у каждого эмитента это делается по-своему)
  3. ACS отправляет в браузер клиента форму авторизации.
  4. Клиент заполняет форму авторизации и отправляет её в ACS.
  5. ACS обрабатывает заполненную форму и вне зависимости от результата передает браузеру redirect на URL страницы платежного шлюза. Вместе с этим URL передаются зашифрованные параметры результата авторизации.
  6. Браузер клиента запрашивает страницу платежного шлюза, передавая зашифрованные параметры результата авторизации. Если авторизация прошла успешно, то выполняется следующий шаг сценария.  

10. Платёжный шлюз производит оплату (списание денежных средств со счёта клиента)

11. После проведения оплаты платежный шлюз передает браузеру клиента URL возврата на страницу магазина (указанный ранее магазином при регистрации заказа, см. шаг 2).

12. Браузер клиента запрашивает страницу с результатами оплаты у магазина.

13. Система магазина запрашивает у платежного шлюза статус оплаты заказа (по уникальному идентификатору заказа в платежной системе, который был получен при регистрации заказа в параметре orderId).
Спецификация обычного запроса состояния заказа представлена в разделах:
    - "Запрос состояния заказа" (SOAP),
    - "Запрос состояния заказа" (REST).
Спецификация расширенного запроса состояния заказа представлена в разделах:
    - "Расширенный запрос состояния заказа" (SOAP),
    - "Расширенный запрос состояния заказа" (REST).

14. Платежный шлюз возвращает статус оплаты.

15. Система магазина передает в браузер клиента страницу с результатами оплаты – успешный платеж или неуспешный.

### 1.2. Отмена оплаты заказа
Отмена оплаты заказа доступна магазинам при наличии соответствующих прав (по согласованию с банком). При одностадийных платежах отмена платежа возможна для заказов в состоянии "Завершён" / "Deposited".
Отмена оплаты заказа осуществляется стандартными средствами:
Через административную консоль (описание представлено в документе "Инструкция по работе с консолью", раздел "Работа с
заказами");
С помощью API, посредством интерфейсов REST / SOAP. Спецификация запроса представлена в разделах:  
 - "Запрос отмены оплаты заказа" (SOAP),  
 - "Запрос отмены оплаты заказа" (REST).  

В случае успешной операции отмены заказ будет переведён из состояния "Завершён"/"Deposited" в состояние "Отменён"/"Reversed".

### 1.3. Возврат средств оплаты заказа
Полный или частичный возврат по оплаченным заказам (в состоянии "Завершён"/"Deposited") осуществляется стандартными
средствами:
Через административную консоль (описание представлено в документе "Инструкция по работе с консолью", раздел "Работа с
заказами");
С помощью API, посредством интерфейсов SOAP / REST. Спецификация запроса представлена в разделах:  
 - "Запрос возврата средств оплаты заказа" (SOAP),  
 - "Запрос возврата средств оплаты заказа" (REST).  

После того, как в РБС приходит запрос на возврат средств, отправленный одним из указанных выше способов, РБС осуществляет
возврат указанной суммы на счёт клиента.

### 1.4. Проверка вовлечённости карты в 3DS
Система позволяет магазину при необходимости самостоятельно проверить вовлечённость банковской карты в 3-D Secure. Это можно
сделать с помощью API, посредством интерфейсов SOAP / REST. Спецификация запроса представлена в разделах:  
 - "Запрос проверки вовлечённости карты в 3DS" (SOAP),  
 - "Запрос проверки вовлечённости карты в 3DS" (REST).  

### 1.5. Добавление в заказ дополнительных параметров
Система позволяет в случае необходимости добавить в заказ дополнительные параметры. Это можно сделать с помощью API,
посредством интерфейсов SOAP / REST. Спецификация запроса представлена в разделах:  
 - "Запрос добавления дополнительных параметров к заказу" (SOAP),  
 - "Запрос добавления дополнительных параметров к заказу" (REST).  

### 1.6. Статистика по платежам за определённый период
Система позволяет формировать статистику по платежам за определенный период с помощью API, посредством интерфейсов SOAP / R
EST. Спецификация запроса представлена в разделах:  
 - "Запрос статистики по платежам за период" (SOAP),  
 - "Запрос статистики по платежам за период" (REST).  
